#!/bin/bash

function usage()
{
    cat <<EOF

  Usage: $0 [-m|--mono]|[-s|--stereo]|[-h|--help]

  Run many programs needed to start a HyperCube session.

  Runs the following 6 programs:

    hy_stopx                   makes sure no user X sessions are running
    hy_startx                  start a user login X session
    hy_edgeBlend_on            turn on screen edge blending
    hy_projectors_on [--mono]  turn on projects
    hy_frameLock_on            turn on nvidia frame locking
    hy_syncToVBlank_on         turn on nvidia sync to verticle refresh

  By default we turn on the projector for stereo display, not --mono.

EOF

    exit 1
}

function Run()
{
    echo "$*"
    if ! $* ; then
        echo
        echo "$* FAILED"
        exit 1
    fi
}


# default mono is off
mono=


while [ -n "$1" ] ; do
    case $1 in
        -h|--h*)
            usage
            ;;
        -m|-mono|--m|--mono)
            mono="--mono"
            ;;
        -s|-stereo|--s|--stereo)
            mono=
            ;;
        *)
            usage
            ;;
    esac
    shift 1
done

# first kill any old user X sessions
Run hy_stopx
Run hy_startx


# TODO: need an error check here
hy_projectors_on $mono &
proj_pid=$!

displaySave="$DISPLAY"

# test that a particular X server is running
# startx may have failed or not finished starting yet
# so we test it here with xset
display=":0.15"
export DISPLAY=$display

count=0
while ! xset -q > /dev/null ; do
    echo "Failed ($count seconds) to run a good X session yet."
    let count=$count+1
    if [ $count = 40 ] ; then
        cat <<EOF
 Failed ($count seconds) $count tries to connect to X server at DISPLAY=$DISPLAY

EOF
        exit 1
    fi
    sleep 1
done

echo "found a good X server at DISPLAY=$display"

[ -n "$displaySave" ] && export DISPLAY="$displaySave"

# TODO: We will not get an error check here until nvidia fixes
# the return status value from the nvidia-settings program.

# all 3 are nvidia driver scripts.
Run hy_edgeBlend_on
Run hy_frameLock_on
Run hy_syncToVBlank_on

# Hang this script until the projectors finish sending back replies.
# It's likely they are on now but just not showing any light yet.
wait $proj_pid

echo "Started Okay"

